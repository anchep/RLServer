# 实现RLServer C#客户端（Win10兼容）

## 项目结构

1. 在`c:\Project\RLServer`目录下创建C# WinForms项目
2. 项目名称：`RLServerClient`
3. 目标框架：`.NET 8.0`（完全兼容Win10）
4. C#版本：C# 2026

## 核心功能实现

### 1. API客户端模块

* 创建`ApiClient`类，封装所有与RLServer的API通信

* 实现HTTP请求封装，支持GET/POST方法

* 处理JWT认证，自动添加Authorization头

* **添加硬件ID**：在所有API请求头中包含硬件ID

* **添加IP地址**：在所有API请求头中包含从`https://myip.ipip.net`获取的公网IP地址

* 实现错误处理和重试机制

### 2. 硬件ID生成模块

* 创建`HardwareIdGenerator`类

* **获取CPUID**：使用`System.Management`命名空间或直接调用Win32 API获取CPU唯一标识

* **获取网卡MAC地址**：获取本地活动网卡的MAC地址

* **生成规则**：CPUID + 网卡MAC地址 + "280i.com" 组合成字符串

* **哈希处理**：对组合字符串调用`GetHashCode()`方法生成最终硬件ID

* **唯一性保证**：确保生成的硬件ID在不同设备上具有唯一性

### 3. IP地址获取与解析模块

* 创建`IpAddressManager`类

* **获取公网IP**：从`https://myip.ipip.net`获取公网IP地址

* **解析IP**：解析返回的HTML内容，提取纯IP地址

* **缓存机制**：缓存IP地址，定期更新（默认每1小时更新一次）

* **降级方案**：若无法从指定URL获取IP，使用本地网络接口IP作为备用

### 4. 数据模型

* 创建与API响应对应的C#类

* User模型：包含用户基本信息和VIP到期时间

* **Software模型**：扩展包含软件名、中文名、简介、介绍、可执行程序名、版本号

* RechargeRecord模型：包含充值记录

* Card模型：包含卡密信息

### 5. 主界面设计

* 采用选项卡式布局，包含以下功能页面：

  * 服务器状态页

  * 登录/注册页

  * 用户信息页

  * 软件管理页

  * 充值页

  * 充值记录页

  * 购卡页

### 6. 功能实现

#### 6.1 服务器状态指示

* **首次检测**：程序启动时调用`/health`接口检查服务器状态

* **检测逻辑**：首次检测后停止定期检测，仅通过心跳判断服务器状态

* **心跳失败处理**：当心跳请求失败时，自动开启服务器状态检测（每5秒一次）

* **恢复逻辑**：服务器恢复后，停止检测，回到仅依赖心跳的状态

* **状态同步**：实时同步服务器在线/离线状态到界面指示灯

* **显示内容**：服务器状态、响应时间、上次检测时间、当前公网IP

#### 6.2 注册功能

* 实现用户注册表单

* **包含硬件ID**：注册请求中自动包含生成的硬件ID

* **包含IP地址**：注册请求中自动包含获取的公网IP地址

* 调用`POST /api/auth/register`接口

* 处理注册成功/失败逻辑

#### 6.3 邮箱验证

* 实现邮箱验证表单

* 调用`POST /api/auth/verify-email`接口

* 处理验证结果

#### 6.4 登录功能

* 实现登录表单

* **包含硬件ID**：登录请求中自动包含生成的硬件ID

* **包含IP地址**：登录请求中自动包含获取的公网IP地址

* 调用`POST /api/auth/login`接口

* 保存JWT token和refresh token

* 实现自动登录功能

* **VIP到期提示**：

  * 登录时检查用户VIP到期时间

  * 若到期时间在当前时间1天内，显示提示信息

  * **每日仅提示一次**：使用本地配置记录上次提示日期，避免重复提示

#### 6.5 用户信息显示

* 调用`GET /api/protected/users/me`接口获取用户信息

* 在界面上显示用户详细信息，包括VIP到期时间

* 支持刷新用户信息

#### 6.6 软件管理（核心功能）

##### 6.6.1 软件显示

* **显示方式**：列表或区块（卡片）方式切换显示

* **显示内容**：

  * 软件名（英文）

  * 中文名

  * 简介

  * 详细介绍

  * 可执行程序名

  * 程序版本号

  * 运行状态

##### 6.6.2 软件检测与下载

* **本地检测**：检查本地相对目录`bin`下是否存在对应可执行程序

* **下载机制**：

  * 若本地缺少程序，自动从`http://www.280i.com/soft/280i-Login3/{软件名}.zip`下载

  * 下载目录：本地`tmp`目录

  * 解压目录：本地`bin`目录

  * **自动安装**：下载完成后自动解压，无需用户干预

* **进度提示**：显示下载和解压进度

##### 6.6.3 软件启动与管理

* 实现软件启动功能

* **权限检查**：启动前再次验证用户是否有权使用该软件

* **参数传递**：支持向启动的软件传递参数（预留功能，用于后期联调）

* **进程跟踪**：将启动的进程添加到`ProcessManager`管理列表

* **运行状态显示**：在界面上直观显示软件运行状态

* **自动最小化**：软件启动成功后，客户端自动最小化到任务栏

#### 6.7 心跳功能

* 定期调用`POST /api/heartbeat`接口（默认30秒一次）

* **包含硬件ID**：心跳请求中自动包含生成的硬件ID

* **包含IP地址**：心跳请求中自动包含获取的公网IP地址

* 保持用户在线状态

* 处理心跳失败逻辑：触发服务器状态检测

#### 6.8 充卡功能

* 实现充值表单

* **包含IP地址**：充值请求中自动包含获取的公网IP地址

* 调用`POST /api/protected/recharge`接口

* 处理充值成功/失败逻辑

#### 6.9 充卡记录

* 调用`GET /api/protected/recharge/logs`获取充值记录

* 以列表方式显示记录

* 支持分页和筛选

#### 6.10 登出功能

* 调用`POST /api/auth/logout`接口

* 清除本地存储的token

* 重置用户状态

* **关闭所有软件**：调用`ProcessManager`关闭所有启动的软件进程

#### 6.11 购卡页面

* 使用WebView2控件集成Edge浏览器（Win10兼容）

* 显示购卡网页

* 支持与主程序的交互

### 7. 辅助功能

* 实现配置管理，支持修改服务器地址等配置

* 实现日志记录功能

* 实现异常处理机制

* 实现主题切换（可选）

## 技术栈（Win10兼容）

* C# 2026（最新版本，兼容Win10）

* WinForms（原生Win10支持）

* .NET 8.0（完全兼容Win10 1709及以上版本）

* HttpClient（内置，兼容Win10）

* Newtonsoft.Json（兼容Win10）

* WebView2（兼容Win10 1803及以上版本，自动安装依赖）

* System.Diagnostics（进程管理，原生支持）

* System.Management（获取硬件信息，原生支持）

* System.IO.Compression（解压功能，内置支持）

## Win10兼容性保障

1. 目标框架选择`.NET 8.0`，确保在Win10上稳定运行

2. WebView2采用兼容模式，自动处理Win10上的依赖安装

3. 避免使用Win11特有的API和控件

4. 测试在Win10环境下的运行情况

5. 提供详细的安装说明和依赖要求

## 实现步骤

1. 创建C# WinForms项目

2. 实现IP地址获取与解析模块

3. 实现硬件ID生成模块

4. 实现ApiClient类，包含硬件ID和IP地址处理

5. 定义数据模型，扩展Software模型

6. 设计主界面，特别是软件管理页面

7. 实现软件检测、下载、解压功能

8. 实现软件启动和进程跟踪功能

9. 实现客户端退出时自动关闭软件功能

10. 实现参数传递预留功能

11. 实现软件启动后客户端自动最小化功能

12. 实现VIP到期提示功能

13. 实现其他功能模块

14. 测试与调试

15. 优化用户体验

16. 打包发布

## 项目文件结构

```
RLServer/
├── src/                    # RLServer后端代码
├── RLServerClient/         # 客户端项目目录
│   ├── App.config
│   ├── Form1.cs
│   ├── Form1.Designer.cs
│   ├── Form1.resx
│   ├── Models/
│   │   ├── User.cs
│   │   ├── Software.cs
│   │   ├── RechargeRecord.cs
│   │   └── Card.cs
│   ├── Services/
│   │   ├── ApiClient.cs
│   │   ├── HardwareIdGenerator.cs
│   │   └── ProcessManager.cs
│   ├── Utils/
│   │   ├── ConfigManager.cs
│   │   ├── DownloadManager.cs
│   │   └── Logger.cs
│   ├── RLServerClient.csproj
│   └── Program.cs
├── docker-compose.yml
└── README.md
```

## 核心代码设计

### 软件启动后自动最小化

```csharp
// 在启动软件时调用
private void StartSoftwareButton_Click(object sender, EventArgs e)
{
    // 获取选中的软件
    Software selectedSoftware = GetSelectedSoftware();
    
    // 构建完整的可执行文件路径
    string executablePath = Path.Combine(Application.StartupPath, "bin", selectedSoftware.ExecutableName);
    
    // 构建参数
    string arguments = BuildSoftwareArguments(selectedSoftware);
    
    // 启动软件
    _processManager.StartSoftware(executablePath, arguments);
    
    // 软件启动后，客户端自动最小化
    this.WindowState = FormWindowState.Minimized;
}
```

### VIP到期提示功能

```csharp
// User模型扩展
public class User
{
    public int Id { get; set; }
    public string Username { get; set; }
    public string Email { get; set; }
    public DateTime VipEndTime { get; set; }
    // 其他用户属性
}

// 登录时检查VIP到期时间
private async Task HandleVipExpirationCheck(User user)
{
    // 检查VIP是否即将到期（1天内）
    TimeSpan timeUntilExpiration = user.VipEndTime - DateTime.Now;
    if (timeUntilExpiration > TimeSpan.Zero && timeUntilExpiration < TimeSpan.FromDays(1))
    {
        // 获取上次提示日期
        string lastPromptDate = _configManager.GetSetting("LastVipExpirationPromptDate", string.Empty);
        string today = DateTime.Now.ToString("yyyy-MM-dd");
        
        // 仅当今天未提示过时才显示提示
        if (lastPromptDate != today)
        {
            string message = $"您的VIP将于{user.VipEndTime.ToString("yyyy-MM-dd HH:mm:ss")}到期，请及时续费！";
            MessageBox.Show(message, "VIP到期提醒", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            
            // 更新上次提示日期
            _configManager.SetSetting("LastVipExpirationPromptDate", today);
        }
    }
}

// 在登录成功后调用
private async void LoginSuccess(User user)
{
    // 保存用户信息
    _currentUser = user;
    
    // 检查VIP到期时间
    await HandleVipExpirationCheck(user);
    
    // 其他登录成功处理逻辑
}
```

