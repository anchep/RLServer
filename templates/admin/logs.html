{% extends "base.html" %}

{% block title %}操作日志 - 后台管理系统{% endblock %}

{% block content %}
<h1 class="page-title">操作日志</h1>

<div class="logs-container">
    <!-- 筛选表单 -->
    <div class="filter-form card mb-4">
        <div class="card-body">
            <form method="get" action="/admin/dashboard/logs">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="action" class="form-label">操作类型</label>
                        <select class="form-select" id="action" name="action">
                            <option value="">全部</option>
                            <option value="login">登录</option>
                            <option value="logout">登出</option>
                            <option value="add">添加</option>
                            <option value="edit">编辑</option>
                            <option value="delete">删除</option>
                            <option value="change_password">修改密码</option>
                            <option value="change_email">修改邮箱</option>
                            <option value="generate_cards">生成卡密</option>
                            <option value="batch_delete">批量删除</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="username" class="form-label">操作者</label>
                        <input type="text" class="form-control" id="username" name="username" placeholder="请输入用户名">
                    </div>
                    <div class="col-md-2">
                        <label for="start_date" class="form-label">开始时间</label>
                        <input type="date" class="form-control" id="start_date" name="start_date">
                    </div>
                    <div class="col-md-2">
                        <label for="end_date" class="form-label">结束时间</label>
                        <input type="date" class="form-control" id="end_date" name="end_date">
                    </div>
                    <div class="col-md-2 align-self-end">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">筛选</button>
                            <a href="/admin/dashboard/logs" class="btn btn-secondary">重置</a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 日志列表 -->
    <div class="logs-table card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>操作时间</th>
                            <th>操作者</th>
                            <th>操作类型</th>
                            <th>操作详情</th>
                            <th>IP地址</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if logs|length > 0 %}
                            {% for log in logs %}
                                <tr>
                                    <td>{{ log.id }}</td>
                                    <td>{{ log.created_at | format_date }}</td>
                                    <td>{{ log.admin_username }}</td>
                                    <td>
                                        <span class="badge bg-primary">
                                            {% if log.action == "login" %}登录{% elif log.action == "logout" %}登出{% elif log.action == "add" %}添加{% elif log.action == "edit" %}编辑{% elif log.action == "delete" %}删除{% elif log.action == "change_password" %}修改密码{% elif log.action == "change_email" %}修改邮箱{% elif log.action == "generate_cards" %}生成卡密{% elif log.action == "batch_delete" %}批量删除{% else %}{{ log.action }}{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ log.details }}</td>
                                    <td>{{ log.ip_address }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center">暂无操作日志</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- 分页控件 -->
            {% if total_pages > 1 %}
            <div class="pagination-container">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page - 1 }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}
                        
                        <!-- 显示首页 -->
                        {% if page > 3 %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1">1</a>
                            </li>
                            {% if page > 4 %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">...</a>
                                </li>
                            {% endif %}
                        {% endif %}
                        
                        <!-- 显示当前页附近的页码 -->
                        {% set start = page - 2 %}
                        {% if start < 1 %}
                            {% set start = 1 %}
                        {% endif %}
                        {% set end = page + 2 %}
                        {% if end > total_pages %}
                            {% set end = total_pages %}
                        {% endif %}
                        
                        {% if start == 2 %}
                            {% set start = 1 %}
                        {% endif %}
                        
                        {% if end == total_pages - 1 %}
                            {% set end = total_pages %}
                        {% endif %}
                        
                        {% if start <= 2 %}
                            {% set start = 1 %}
                        {% endif %}
                        
                        {% if end >= total_pages - 1 %}
                            {% set end = total_pages %}
                        {% endif %}
                        
                        {% if start > 1 %}
                            {% set start = start + 1 %}
                        {% endif %}
                        
                        {% if end < total_pages %}
                            {% set end = end - 1 %}
                        {% endif %}
                        
                        <!-- 简单的页码显示，只显示当前页 -->
                        <li class="page-item active">
                            <a class="page-link" href="?page={{ page }}">{{ page }}</a>
                        </li>
                        
                        <!-- 显示末页 -->
                        {% if page < total_pages - 2 %}
                            {% if page < total_pages - 3 %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">...</a>
                                </li>
                            {% endif %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ total_pages }}">{{ total_pages }}</a>
                            </li>
                        {% endif %}
                        
                        {% if page < total_pages %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page + 1 }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 统计信息 -->
    <div class="stats mt-4">
        <p class="text-muted">共 {{ total_logs }} 条操作日志，当前第 {{ page }} / {{ total_pages }} 页</p>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .logs-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .filter-form {
        margin-bottom: 1rem;
    }
    
    .logs-table {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 8px;
    }
    
    .pagination-container {
        margin-top: 1rem;
    }
    
    .stats {
        text-align: right;
    }
    
    .badge {
        font-size: 0.85rem;
    }
</style>
{% endblock %}