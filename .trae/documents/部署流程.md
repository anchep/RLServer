# RLServer 部署流程

## 1. 环境准备

### 1.1 安装 Docker 和 Docker Compose
- 确保已安装 Docker Desktop (Windows/macOS) 或 Docker Engine (Linux)
- 确保 Docker Compose 已安装

### 1.2 克隆项目代码
```bash
git clone https://github.com/anchep/RLServer.git
cd RLServer
```

## 2. 配置文件设置

### 2.1 环境变量配置
- 复制环境变量示例文件
```bash
cp .env.example .env
```

- 编辑 `.env` 文件，根据实际情况修改配置：
```
# 数据库连接配置
DATABASE_URL=postgres://admin:password@localhost:5432/rl_server

# JWT配置
JWT_SECRET=your-secret-key-here

# 心跳间隔（秒）
HEARTBEAT_INTERVAL=600

# 清理间隔（秒）
CLEANUP_INTERVAL=300

# 服务器端口
SERVER_PORT=28001
```

## 3. Docker 编译与部署

### 3.1 构建 Docker 镜像
- 使用 Docker Compose 构建镜像
```bash
docker-compose build
```

### 3.2 SSL证书准备（HTTPS支持）
- 生成自签名SSL证书（开发环境）
```bash
# 创建SSL证书目录
mkdir -p ssl

# 生成自签名证书
openssl req -x509 -newkey rsa:4096 -keyout ssl/key.pem -out ssl/cert.pem -days 365 -nodes -subj "/CN=localhost"
```

- 生产环境建议使用真实SSL证书（如Let's Encrypt）

### 3.3 启动服务
- 在后台启动服务
```bash
docker-compose up -d
```

- 查看服务状态
```bash
docker-compose ps
```

- 查看日志
```bash
docker-compose logs -f
```

### 3.4 停止服务
```bash
docker-compose down
```

- 停止服务并清理数据卷（谨慎使用）
```bash
docker-compose down -v
```

### 3.5 HTTPS访问
- HTTP访问：`http://localhost:28001`（自动重定向到HTTPS）
- HTTPS访问：`https://localhost:28043`

## 4. 服务测试

### 4.1 测试注册功能
```bash
# Windows PowerShell
Invoke-WebRequest -Uri http://localhost:28001/api/auth/register -Method POST -ContentType "application/json" -Body '{"username":"test_user","password":"123456","email":"test@example.com"}' -UseBasicParsing

# Linux/macOS
curl -X POST -H "Content-Type: application/json" -d '{"username":"test_user","password":"123456","email":"test@example.com"}' http://localhost:28001/api/auth/register
```

### 4.2 测试登录功能
```bash
# Windows PowerShell
Invoke-WebRequest -Uri http://localhost:28001/api/auth/login -Method POST -ContentType "application/json" -Body '{"username":"test_user","password":"123456","hardware_code":"hw-test","software_version":"v1.0.0"}' -UseBasicParsing

# Linux/macOS
curl -X POST -H "Content-Type: application/json" -d '{"username":"test_user","password":"123456","hardware_code":"hw-test","software_version":"v1.0.0"}' http://localhost:28001/api/auth/login
```

### 4.3 测试心跳功能

1. **先获取登录token**：
   ```bash
   # Windows PowerShell
   $login_response = Invoke-WebRequest -Uri http://localhost:28001/api/auth/login -Method POST -ContentType "application/json" -Body '{"username":"test_user","password":"123456","hardware_code":"hw-test","software_version":"v1.0.0"}' -UseBasicParsing -Headers @{"Accept"="application/json"}
   $token = ($login_response.Content | ConvertFrom-Json).token
   
   # Linux/macOS
   token=$(curl -s -X POST -H "Content-Type: application/json" -d '{"username":"test_user","password":"123456","hardware_code":"hw-test","software_version":"v1.0.0"}' http://localhost:28001/api/auth/login | jq -r '.token')
   ```

2. **发送心跳请求**：
   ```bash
   # Windows PowerShell
   Invoke-WebRequest -Uri http://localhost:28001/api/heartbeat -Method POST -ContentType "application/json" -Body "{\"session_token\":\"$token\",\"hardware_code\":\"hw-test\",\"software_version\":\"v1.0.0\"}" -UseBasicParsing
   
   # Linux/macOS
   curl -X POST -H "Content-Type: application/json" -d '{"session_token":"'$token'","hardware_code":"hw-test","software_version":"v1.0.0"}' http://localhost:28001/api/heartbeat
   ```

### 4.4 测试退出登录功能

1. **先获取登录token**（如果已经有token可以跳过）：
   ```bash
   # Windows PowerShell
   $login_response = Invoke-WebRequest -Uri http://localhost:28001/api/auth/login -Method POST -ContentType "application/json" -Body '{"username":"test_user","password":"123456","hardware_code":"hw-test","software_version":"v1.0.0"}' -UseBasicParsing -Headers @{"Accept"="application/json"}
   $token = ($login_response.Content | ConvertFrom-Json).token
   
   # Linux/macOS
   token=$(curl -s -X POST -H "Content-Type: application/json" -d '{"username":"test_user","password":"123456","hardware_code":"hw-test","software_version":"v1.0.0"}' http://localhost:28001/api/auth/login | jq -r '.token')
   ```

2. **发送退出登录请求**：
   ```bash
   # Windows PowerShell
   Invoke-WebRequest -Uri http://localhost:28001/api/auth/logout -Method POST -ContentType "application/json" -Body "{\"session_token\":\"$token\"}" -UseBasicParsing
   
   # Linux/macOS
   curl -X POST -H "Content-Type: application/json" -d '{"session_token":"'$token'"}' http://localhost:28001/api/auth/logout
   ```

3. **验证token失效**（使用已退出的token再次发送心跳请求，应该返回错误）：
   ```bash
   # Windows PowerShell
   Invoke-WebRequest -Uri http://localhost:28001/api/heartbeat -Method POST -ContentType "application/json" -Body "{\"session_token\":\"$token\",\"hardware_code\":\"hw-test\",\"software_version\":\"v1.0.0\"}" -UseBasicParsing
   
   # Linux/macOS
   curl -X POST -H "Content-Type: application/json" -d '{"session_token":"'$token'","hardware_code":"hw-test","software_version":"v1.0.0"}' http://localhost:28001/api/heartbeat
   ```

## 5. 部署验证

### 5.1 检查服务状态
- 查看容器运行状态
```bash
docker-compose ps
```

- 检查服务日志
```bash
docker-compose logs -f app
```

### 5.2 API 接口测试
- 注册成功响应示例：
```json
{
  "message": "Registration successful. Please check your email for verification code."
}
```

- 登录成功响应示例：
```json
{
  "message": "Login successful",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

- 心跳成功响应示例：
```json
{
  "message": "Heartbeat received successfully"
}
```

- 退出登录成功响应示例：
```json
{
  "message": "Logout successful"
}
```

- 退出登录错误响应示例（无效token）：
```json
{
  "error": "Logout token error"
}
```

- 心跳错误响应示例（无效token）：
```json
{
  "error": "找不到此token"
}
```

## 6. 常见问题与解决方案

### 6.1 数据库连接失败
- 错误信息：`database "rl_server" does not exist`
- 解决方案：清理数据卷并重新启动服务
```bash
docker-compose down -v
docker-compose up -d
```

### 6.2 Docker 服务无法启动
- 错误信息：`unable to get image 'postgres:15': error during connect`
- 解决方案：确保 Docker Desktop 或 Docker Engine 已启动

### 6.3 注册时缺少 email 字段
- 错误信息：`Json deserialize error: missing field \`email\` at line 1 column 44`
- 解决方案：注册请求中必须包含 email 字段

### 6.4 用户名已存在
- 错误信息：`{"error":"Bad Request: Username already exists"}`
- 解决方案：使用新的用户名进行注册

### 6.5 退出登录时无效token
- 错误信息：`{"error":"Logout token error"}`
- 解决方案：确保使用有效的session_token，检查token是否已过期或已被使用

## 7. 服务监控与维护

### 7.1 查看服务日志
```bash
docker-compose logs -f
```

### 7.2 重启服务
```bash
docker-compose restart
```

### 7.3 更新服务
```bash
git pull
docker-compose build
docker-compose down
docker-compose up -d
```

## 8. 安全建议

1. 生产环境中修改默认数据库密码
2. 生成强随机的 JWT_SECRET
3. 配置适当的防火墙规则，限制访问端口
4. 定期备份数据库
5. 定期更新 Docker 镜像和依赖

## 9. 部署架构

```
┌─────────────────┐     ┌─────────────────┐
│  Docker Compose │     │  Docker Hub     │
└─────────────────┘     └─────────────────┘
          │                        │
          ▼                        ▼
┌─────────────────┐     ┌─────────────────┐
│  RLServer App   │────▶│  PostgreSQL DB  │
└─────────────────┘     └─────────────────┘
          │
          ▼
┌─────────────────┐
│  External API   │
└─────────────────┘
```

## 10. 相关链接

- [项目 GitHub 地址](https://github.com/anchep/RLServer.git)
- [Docker 官方文档](https://docs.docker.com/)
- [Docker Compose 文档](https://docs.docker.com/compose/)
- [Rust 官方文档](https://www.rust-lang.org/zh-CN/documentation)
- [Actix Web 文档](https://actix.rs/docs/)