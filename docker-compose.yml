services:
  db:
    image: postgres:18.1
    restart: unless-stopped
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
      POSTGRES_DB: rl_server
      POSTGRES_INITDB_ARGS: --encoding=UTF8
    volumes:
      - postgres_data:/var/lib/postgresql
      - ./migrations:/docker-entrypoint-initdb.d/migrations:ro
    # 暴露端口用于访问
    ports:
      - "5432:5432"
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d rl_server"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  
  app:
    image: rlserver-app:latest
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      db:
        condition: service_started
    env_file:
      - .env
    environment:
      - HOST_PUBLIC_IP=$(curl -s ifconfig.me)  # Linux宿主机动态获取
    volumes:
      # 开发环境挂载模板文件和静态资源，方便修改
      - ./templates:/app/templates:ro
      - ./static:/app/static:ro
    expose:
      - "28001"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  
  nginx:
    image: nginx:1.29.4
    restart: unless-stopped
    depends_on:
      - db
      - app
    ports:
      - "28001:80"
      - "28043:443"
    volumes:
      # SSL证书卷（手动配置）
      - ./ssl:/etc/nginx/ssl:ro
      # Nginx配置文件
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # 静态文件目录，可选择挂载
      - ./static:/var/www/static:ro
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres_data:
    driver: local
