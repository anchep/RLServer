{% extends "base.html" %}

{% block title %}操作日志 - 后台管理系统{% endblock %}

{% block page_title %}操作日志{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面操作栏 -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h4">操作日志</h2>
            </div>
        </div>
    </div>
    
    <!-- 筛选和搜索 -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" action="/admin/dashboard/logs" class="d-flex flex-wrap gap-2">
                        <div class="flex-grow-1">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <label for="action" class="form-label">操作类型</label>
                                    <select class="form-select" id="action" name="action">
                                        <option value="" {% if action == "" %}selected{% endif %}>全部</option>
                                        <option value="login" {% if action == "login" %}selected{% endif %}>登录</option>
                                        <option value="logout" {% if action == "logout" %}selected{% endif %}>登出</option>
                                        <option value="add" {% if action == "add" %}selected{% endif %}>添加</option>
                                        <option value="edit" {% if action == "edit" %}selected{% endif %}>编辑</option>
                                        <option value="delete" {% if action == "delete" %}selected{% endif %}>删除</option>
                                        <option value="change_password" {% if action == "change_password" %}selected{% endif %}>修改密码</option>
                                        <option value="change_email" {% if action == "change_email" %}selected{% endif %}>修改邮箱</option>
                                        <option value="generate_cards" {% if action == "generate_cards" %}selected{% endif %}>生成卡密</option>
                                        <option value="batch_delete" {% if action == "batch_delete" %}selected{% endif %}>批量删除</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="username" class="form-label">操作者</label>
                                    <select class="form-select" id="username" name="username">
                                        <option value="" {% if username == "" %}selected{% endif %}>全部</option>
                                        {% for admin in all_admin_users %}
                                            <option value="{{ admin.username }}" {% if username == admin.username %}selected{% endif %}>{{ admin.username }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="start_time" class="form-label">开始时间</label>
                                    <input type="datetime-local" class="form-control" id="start_time" name="start_time" value="{{ start_time }}">
                                </div>
                                <div class="col-md-3">
                                    <label for="end_time" class="form-label">结束时间</label>
                                    <input type="datetime-local" class="form-control" id="end_time" name="end_time" value="{{ end_time }}">
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 align-items-end">
                            <button type="submit" class="btn btn-secondary">
                                <i class="bi bi-search"></i> 筛选
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                                <i class="bi bi-arrow-repeat"></i> 重置
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="exportLogs()">
                                <i class="bi bi-download"></i> 导出记录
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 操作日志列表 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>操作时间</th>
                                    <th>操作者</th>
                                    <th>操作类型</th>
                                    <th>操作详情</th>
                                    <th>IP地址</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if logs|length > 0 %}
                                    {% for log in logs %}
                                        <tr>
                                            <td>{{ log.id }}</td>
                                            <td>{{ log.created_at | format_date }}</td>
                                            <td>{{ log.admin_username }}</td>
                                            <td>
                                                <span class="badge bg-primary">
                                                    {% if log.action == "login" %}登录{% elif log.action == "logout" %}登出{% elif log.action == "add" %}添加{% elif log.action == "edit" %}编辑{% elif log.action == "delete" %}删除{% elif log.action == "change_password" %}修改密码{% elif log.action == "change_email" %}修改邮箱{% elif log.action == "generate_cards" %}生成卡密{% elif log.action == "batch_delete" %}批量删除{% else %}{{ log.action }}{% endif %}
                                                </span>
                                            </td>
                                            <td>{{ log.details }}</td>
                                            <td>{{ log.ip_address }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            <i class="bi bi-info-circle"></i> 暂无操作日志
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 分页 -->
    <div class="row mt-3">
        <div class="col-md-12">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ page - 1 }}{% if action %}&action={{ action }}{% endif %}{% if username %}&username={{ username }}{% endif %}{% if start_time %}&start_time={{ start_time }}{% endif %}{% if end_time %}&end_time={{ end_time }}{% endif %}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    
                    <!-- 页码 -->
                    {% if total_pages > 0 %}
                    <li class="page-item active">
                        <a class="page-link" href="#">{{ page }}/{{ total_pages }}</a>
                    </li>
                    {% endif %}
                    
                    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ page + 1 }}{% if action %}&action={{ action }}{% endif %}{% if username %}&username={{ username }}{% endif %}{% if start_time %}&start_time={{ start_time }}{% endif %}{% if end_time %}&end_time={{ end_time }}{% endif %}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // 重置筛选条件
    function resetFilters() {
        window.location.href = '/admin/dashboard/logs';
    }
    
    // 导出操作日志
    function exportLogs() {
        // 这里可以实现导出功能
        showMessage('导出功能开发中', 'info');
    }
    
    // 显示消息提示
    function showMessage(message, type = 'info', duration = 3000) {
        const messageElement = document.createElement('div');
        messageElement.className = `alert alert-${type} alert-dismissible fade show`;
        messageElement.role = 'alert';
        messageElement.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const content = document.querySelector('.content');
        if (content) {
            content.insertBefore(messageElement, content.firstChild);
            
            setTimeout(() => {
                messageElement.classList.remove('show');
                setTimeout(() => {
                    messageElement.remove();
                }, 150);
            }, duration);
        }
    }
    
    // 设置默认日期时间
    document.addEventListener('DOMContentLoaded', function() {
        const startDateInput = document.getElementById('start_time');
        const endDateInput = document.getElementById('end_time');
        
        // 如果没有设置值，则设置默认值
        if (!startDateInput.value) {
            // 当天0:00
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0);
            startDateInput.value = todayStart.toISOString().slice(0, 16); // 格式: 2023-12-28T00:00
        }
        
        if (!endDateInput.value) {
            // 当前时间
            const now = new Date();
            endDateInput.value = now.toISOString().slice(0, 16); // 格式: 2023-12-28T14:30
        }
    });
</script>
{% endblock %}
{% endblock %}

