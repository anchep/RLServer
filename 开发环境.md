# 开发环境配置文档

## 环境配置
- **IDE运行环境**：Windows 11 64位系统
- **已安装软件**：
  - Python
  - Docker Desktop（用于运行Docker容器）
  - Rust编译器（cargo, rustc）- 推荐使用rustup管理
  - Visual Studio Build Tools（用于编译Rust代码）
- **项目部署方式**：Docker-compose部署开发环境
- **项目技术栈**：Rust + PostgreSQL + Nginx
- **版本信息**：
  - Rust: 1.91.1 (stable)
  - PostgreSQL: 18.1
  - Nginx: 1.29.4
  - Docker: 27.0+
  - Docker Compose: 2.29+
- **主要依赖**：
  - Actix Web框架
  - Diesel ORM
  - Tera模板引擎
  - JWT认证
  - actix-session会话管理
  - serde（序列化/反序列化）
  - log + env_logger（日志管理）
  - bcrypt（密码哈希）

## 项目结构
- **根目录文件说明**：
  - `.env`：系统配置文件，包含数据库连接、JWT密钥、服务器端口等配置，Git上传时忽略
  - `.env.example`：环境变量示例文件，用于指导开发者配置自己的.env文件
  - `docker-compose.yml`：Docker-compose配置文件，定义了db、app和nginx三个服务
  - `Dockerfile`：Rust应用的Docker构建文件
  - `nginx.conf`：Nginx容器配置文件，代理请求到后端应用
  - `Cargo.toml`：Rust项目依赖配置文件
  - `src/`：Rust源代码目录
  - `templates/`：Tera模板文件目录
  - `static/`：静态资源目录（CSS, JavaScript）
  - `migrations/`：数据库迁移文件目录
  - `admin/`：后台管理相关代码目录

- **核心配置文件详解**：
  - `.env`文件包含数据库连接、JWT配置、服务器配置、心跳配置、清理间隔、SMTP配置等
  - `nginx.conf`配置了反向代理，将请求转发到后端Rust应用
  - `Dockerfile`：基于rust:1.91.1-slim构建，采用多阶段构建优化镜像大小
    - 第一阶段：使用rust:1.91.1-slim编译Rust代码(在docker中编译)
    - 第二阶段：使用debian:bookworm-slim运行应用，仅包含必要的运行时依赖
  - `docker-compose.yml`定义了三个服务：
    - `db`：PostgreSQL数据库服务，使用官方PostgreSQL 18.1镜像
    - `app`：Rust应用服务，**构建自本地Dockerfile**，依赖db服务
      - 注意：rlserver-app:latest是本地编译的镜像，不是从Docker Hub拉取的，通过项目根目录的Dockerfile构建
      - 该镜像仅在本地构建和使用，无需从官方Docker Hub获取
    - `nginx`：Nginx反向代理服务，使用官方Nginx 1.29.4镜像，依赖app服务
  - `docker-compose.yml`配置项说明：
    - 网络配置：使用自定义bridge网络`rl_server_network`
    - 卷挂载：
      - 数据库数据持久化到`./data/postgres`
      - 应用代码挂载到容器内进行开发
      - Nginx配置文件挂载到容器内
    - 环境变量：从.env文件加载配置
    - 端口映射：Nginx暴露28001端口，PostgreSQL暴露5432端口（仅开发环境）

## 常用命令
- **Docker相关命令**：
  ```powershell
  # 构建并启动所有服务（开发模式）
  docker-compose up --build -d
  
  # 构建特定服务
  docker-compose build app
  
  # 启动所有服务（不重新构建）
  docker-compose up -d
  
  # 停止并删除所有服务
  docker-compose down
  
  # 停止并删除所有服务及 volumes
  docker-compose down -v
  
  # 重启所有服务
  docker-compose restart
  
  # 重启特定服务
  docker-compose restart app
  
  # 查看所有服务状态
  docker-compose ps
  
  # 查看应用日志（实时）
  docker-compose logs -f app
  
  # 查看应用日志（最近100行）
  docker-compose logs --tail=100 app
  
  # 查看数据库日志
  docker-compose logs -f db
  
  # 进入应用容器
  docker-compose exec app bash
  
  # 进入数据库容器
  docker-compose exec db psql -U admin -d rl_server
  
  # 查看Docker镜像列表
  docker images
  
  # 删除未使用的Docker镜像
  docker image prune -a
  
  # 查看Docker容器列表
  docker container ls -a
  
  # 删除已停止的Docker容器
  docker container prune
  
  # 检查Docker Compose配置
  docker-compose config
  ```

- **Rust相关命令**：
  ```powershell
  # 初始化Rust项目（如果需要）
  cargo init
  
  # 更新依赖
  cargo update
  
  # 编译Rust代码（调试模式）
  cargo build
  
  # 编译Rust代码（发布模式，优化编译）
  cargo build --release
  
  # 运行Rust代码（调试模式，不使用Docker）
  cargo run
  
  # 运行Rust代码（发布模式）
  cargo run --release
  
  # 运行特定二进制文件
  cargo run --bin create_admin
  
  # 运行测试
  cargo test
  
  # 运行特定测试
  cargo test test_function_name
  
  # 运行测试并显示所有输出
  cargo test -- --nocapture
  
  # 检查代码（不编译，快速检查语法错误）
  cargo check
  
  # 检查代码（发布模式）
  cargo check --release
  
  # 格式化代码
  cargo fmt
  
  # 格式化特定文件
  cargo fmt -- src/main.rs
  
  # 检查代码风格
  cargo clippy
  
  # 检查代码风格并自动修复问题
  cargo clippy --fix
  
  # 生成文档
  cargo doc
  
  # 生成并打开文档
  cargo doc --open
  
  # 查看依赖树
  cargo tree
  
  # 查看特定依赖
  cargo tree -p actix-web
  
  # 清理构建产物
  cargo clean
  
  # 安装Rust工具链
  rustup install stable
  
  # 切换Rust工具链
  rustup default stable
  
  # 更新Rust工具链
  rustup update
  
  # 查看Rust版本信息
  rustc --version
  cargo --version
  rustup --version
  ```

- **其他常用命令**：
  ```powershell
  # 创建管理员用户（第一次运行时需要）
  cargo run --bin create_admin
  
  # 更新管理员密码
  cargo run --bin update_admin_password
  
  # 生成BCrypt哈希
  cargo run --bin generate_bcrypt_hash
  ```

## 常见问题
### Rust相关问题
1. **Rust编译失败**：
   - 错误信息：`LINK : fatal error LNK1181: 无法打开输入文件"libpq.lib"`
   - 解决方案：这是缺少PostgreSQL库文件导致的，建议使用Docker构建和运行应用，避免本地环境配置问题

2. **Rust依赖更新失败**：
   - 错误信息：`failed to download from 'https://crates.io/api/v1/crates/xxx'`
   - 解决方案：配置国内Crates镜像源，在`~/.cargo/config.toml`中添加：
     ```toml
     [source.crates-io]
     replace-with = 'ustc'
     [source.ustc]
     registry = "git://mirrors.ustc.edu.cn/crates.io-index"
     ```

3. **Cargo check 速度慢**：
   - 解决方案：
     - 确保使用最新版本的Rust工具链：`rustup update`
     - 考虑使用`sccache`加速编译：`cargo install sccache`

4. **Clippy检查出大量警告**：
   - 解决方案：
     - 逐个修复警告，或在`Cargo.toml`中配置允许的警告
     - 使用`cargo clippy --fix`自动修复部分问题

### Web相关问题
1. **模板渲染错误：FilterNotFound("not")**：
   - 错误信息：模板渲染错误: Error { kind: Msg( "Failed to render 'admin/user/list.html'"), source: Some( Error { kind: FilterNotFound( "not"), source: None, }, ), }
   - 原因：Tera模板引擎不支持`not`过滤器，代码中使用了`{{ user.status | not }}`
   - 解决方案：将`| not`过滤器替换为条件判断，例如将`{{ user.status | not }}`改为`{% if user.status %}false{% else %}true{% endif %}`

### Docker相关问题
1. **Docker构建缓慢**：
   - 解决方案：
     - 确保Docker Desktop已配置使用国内镜像源
     - 使用Docker BuildKit加速构建：设置环境变量`DOCKER_BUILDKIT=1`
     - 合理安排Dockerfile中的指令顺序，利用Docker缓存

2. **修改代码后不生效**：
   - 解决方案：
     - Rust程序修改后需要重新构建Docker镜像：`docker-compose up --build -d`
     - 确保docker-compose.yml中正确配置了代码挂载

3. **数据库连接失败**：
   - 解决方案：
     - 检查.env文件中的数据库连接配置是否正确
     - 确保Docker服务正常运行：`docker-compose ps`
     - 检查数据库服务是否已启动：`docker-compose logs db`
     - 确保应用服务依赖于db服务（在docker-compose.yml中配置`depends_on`）

4. **Docker容器占用过多磁盘空间**：
   - 解决方案：
     - 定期清理未使用的镜像：`docker image prune -a`
     - 定期清理未使用的容器：`docker container prune`
     - 定期清理未使用的卷：`docker volume prune`
     - 使用Docker Desktop的"Clean/Purge data"功能

5. **Docker Desktop启动失败**：
   - 解决方案：
     - 检查WSL 2是否已正确安装和配置
     - 重启Docker Desktop服务
     - 检查系统资源是否充足

6. **端口冲突**：
   - 错误信息：`Bind for 0.0.0.0:28001 failed: port is already allocated`
   - 解决方案：
     - 检查端口是否被其他进程占用：`netstat -ano | findstr :28001`
     - 停止占用端口的进程，或修改docker-compose.yml中的端口映射

### 其他问题
1. **使用Linux命令调试**：
   - 解决方案：在Windows环境中，请使用PowerShell命令替代Linux命令

2. **环境变量不生效**：
   - 解决方案：
     - 确保.env文件中的配置正确
     - 重启Docker服务使配置生效：`docker-compose restart`
     - 检查docker-compose.yml是否正确加载了.env文件

3. **应用启动后无法访问**：
   - 解决方案：
     - 检查Nginx配置是否正确
     - 检查应用服务是否正常运行：`docker-compose logs app`
     - 检查防火墙设置是否允许端口访问

## 开发规范

### Rust开发规范

#### 代码风格
- 使用Rust官方推荐的代码风格，通过`cargo fmt`格式化代码
- 使用`cargo clippy`检查代码风格和潜在问题，保持0警告
- 函数和变量命名使用蛇形命名法（snake_case）
- 结构体和枚举命名使用驼峰命名法（CamelCase）
- 常量命名使用全大写字母加下划线（UPPER_CASE_WITH_UNDERSCORES）
- 模块命名：使用小写字母，简短描述模块功能

#### 错误处理
- 优先使用`Result`类型进行错误处理，避免使用`panic!`
- 为自定义错误类型实现`std::error::Error` trait
- 使用`thiserror`库简化自定义错误类型的实现
- 使用`anyhow`库简化错误传播

#### 性能优化
- 对于热路径代码，使用`#[inline]`属性
- 避免不必要的内存分配和拷贝，使用引用和借用
- 合理使用`Box`、`Arc`、`Rc`等智能指针
- 对于大集合，考虑使用迭代器而非索引访问
- 使用`#[derive(Debug, Clone, PartialEq)]`等派生宏时注意性能影响

#### 测试规范
- 编写单元测试，覆盖核心功能
- 测试函数命名使用`test_`前缀
- 使用`assert_eq!`、`assert_ne!`等断言宏
- 对于复杂测试场景，使用测试夹具（fixtures）
- 运行测试前确保数据库处于干净状态

### Docker开发规范

#### Dockerfile规范
- 使用多阶段构建优化镜像大小
- 合理安排指令顺序，利用Docker缓存
- 避免在镜像中存储敏感信息
- 使用非root用户运行应用
- 减少镜像层数，合并相关指令
- 明确指定基础镜像版本，避免使用`latest`标签

#### Docker Compose规范
- 将配置分为开发环境和生产环境
- 合理使用环境变量和.env文件
- 为服务指定依赖关系（`depends_on`）
- 配置健康检查（`healthcheck`）
- 合理配置资源限制（`resources`）
- 使用命名卷管理持久化数据

### 提交规范
- 提交信息应清晰描述本次提交的内容
- 提交信息格式：`[类型] 简短描述`
- 类型包括：
  - `feat`：新功能
  - `fix`：修复bug
  - `docs`：文档修改
  - `style`：代码风格修改
  - `refactor`：代码重构
  - `test`：测试相关修改
  - `chore`：构建或工具相关修改
  - `ci`：CI/CD配置修改

### 其他规范
- 编写单元测试，确保代码质量
- 使用适当的注释，解释复杂逻辑
- 遵循Rust的所有权和借用规则
- 遵循RESTful API设计规范
- 定期更新依赖版本，修复安全漏洞
- 使用Git分支管理功能开发和bug修复

## 开发流程
1. **克隆代码仓库**：从Git仓库克隆最新代码
2. **配置环境变量**：
   - 复制.env.example为.env
   - 修改数据库连接、JWT密钥等配置
3. **启动开发环境**：
   ```powershell
   docker-compose up --build -d
   ```
4. **创建管理员用户**（首次运行时）：
   ```powershell
   docker-compose exec app cargo run --bin create_admin
   ```
5. **开发代码**：
   - 修改Rust代码、模板或静态资源
   - 使用IDE进行开发，确保代码符合风格规范
6. **验证代码质量**：
   ```powershell
   # 检查代码语法
   cargo check
   
   # 格式化代码
   cargo fmt
   
   # 检查代码风格
   cargo clippy
   ```
7. **运行测试**：
   ```powershell
   cargo test
   ```
8. **重新构建和测试**：
   - 修改Rust代码后，重新构建容器：
     ```powershell
     docker-compose up --build -d
     ```
   - 在浏览器中访问http://localhost:28001测试应用
9. **提交代码**：
   - 确保所有测试通过
   - 遵循提交规范提交代码
   - 推送代码到Git仓库

## 注意事项

### Rust开发注意事项
- 开发过程中请使用Windows命令，避免使用Linux特有命令
- 每次修改Rust代码后，需要重新构建Docker环境进行测试
- 使用`rustup`管理Rust工具链，保持工具链更新
- 定期运行`cargo update`更新依赖，但注意兼容性
- 遵循Rust的所有权和借用规则，避免不必要的clone
- 使用适当的日志级别，避免在生产环境输出过多日志
- 对敏感数据进行加密处理，避免明文存储

### Docker开发注意事项
- 确保Docker Desktop已正确配置，使用WSL 2后端
- 定期清理Docker镜像和容器，避免占用过多磁盘空间：
  ```powershell
  docker system prune -a
  ```
- 开发完成后，使用`docker-compose down`停止所有服务
- 不要将敏感信息硬编码到Dockerfile或docker-compose.yml中
- 使用国内镜像源加速Docker镜像拉取和Cargo依赖下载
- 在生产环境中，考虑使用Kubernetes或其他容器编排工具
- 定期更新Docker镜像，修复安全漏洞

### 其他注意事项
- 确保.env文件中的敏感信息（如数据库密码、JWT密钥）不被提交到Git
- 遵循最小权限原则，为数据库用户配置适当的权限
- 定期备份数据库数据
- 监控应用运行状态，及时发现和解决问题
- 遵循RESTful API设计规范，保持API的一致性和易用性
- 编写清晰的文档，方便其他开发者理解和使用代码

## 端口说明
- **28001**：HTTP服务器端口
- **28043**：HTTPS服务器端口（如果启用）
- **5432**：PostgreSQL数据库端口（仅开发环境暴露）