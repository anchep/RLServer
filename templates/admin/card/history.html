{% extends "base.html" %}

{% block title %}充值历史 - 后台管理系统{% endblock %}

{% block page_title %}充值历史{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面导航 -->
    <div class="row mb-3">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/admin/dashboard/">仪表板</a></li>
                    <li class="breadcrumb-item"><a href="/admin/dashboard/cards/">卡密管理</a></li>
                    <li class="breadcrumb-item active" aria-current="page">充值历史</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <!-- 筛选和搜索 -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" action="/admin/dashboard/cards/history/" class="d-flex flex-wrap gap-2">
                        <div class="flex-grow-1">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <label for="user_id" class="form-label">用户ID</label>
                                    <input type="number" class="form-control" id="user_id" name="user_id" value="{{ user_id }}" placeholder="请输入用户ID">
                                </div>
                                <div class="col-md-3">
                                    <label for="card_code" class="form-label">卡密代码</label>
                                    <input type="text" class="form-control" id="card_code" name="card_code" value="{{ card_code }}" placeholder="请输入卡密代码">
                                </div>
                                <div class="col-md-3">
                                    <label for="start_time" class="form-label">开始时间</label>
                                    <input type="datetime-local" class="form-control" id="start_time" name="start_time" value="{{ start_time | format_datetime }}">
                                </div>
                                <div class="col-md-3">
                                    <label for="end_time" class="form-label">结束时间</label>
                                    <input type="datetime-local" class="form-control" id="end_time" name="end_time" value="{{ end_time | format_datetime }}">
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 align-items-end">
                            <button type="submit" class="btn btn-secondary">
                                <i class="bi bi-search"></i> 筛选
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                                <i class="bi bi-arrow-repeat"></i> 重置
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="exportHistory()">
                                <i class="bi bi-download"></i> 导出记录
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 消息提示 -->
    {% if error %}
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 充值历史表格 -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户ID</th>
                                    <th>卡密代码</th>
                                    <th>类型</th>
                                    <th>时长（天）</th>
                                    <th>充值时间</th>
                                    <th>IP地址</th>
                                    <th>设备信息</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if history_list | length == 0 %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="bi bi-info-circle"></i> 暂无充值记录
                                    </td>
                                </tr>
                                {% else %}
                                {% for history in history_list %}
                                <tr>
                                    <td>{{ history.id }}</td>
                                    <td>{{ history.user_id }}</td>
                                    <td>{{ history.card_code }}</td>
                                    <td>
                                        {% if history.vip_level == 1 %}
                                        <span class="badge bg-primary">VIP卡</span>
                                        {% elif history.vip_level == 2 %}
                                        <span class="badge bg-success">时长卡</span>
                                        {% elif history.vip_level == 3 %}
                                        <span class="badge bg-warning">功能卡</span>
                                        {% else %}
                                        <span class="badge bg-secondary">未知类型</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ history.duration_days }}</td>
                                    <td>{{ history.created_at | format_date }}</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 分页 -->
    <div class="row mt-3">
        <div class="col-md-12">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ page - 1 }}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if card_code %}&card_code={{ card_code }}{% endif %}{% if start_time %}&start_time={{ start_time }}{% endif %}{% if end_time %}&end_time={{ end_time }}{% endif %}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    
                    <!-- 页码 -->
                    {% if total_pages > 0 %}
                    <li class="page-item active">
                        <a class="page-link" href="#">{{ page }}/{{ total_pages }}</a>
                    </li>
                    {% endif %}
                    
                    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ page + 1 }}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if card_code %}&card_code={{ card_code }}{% endif %}{% if start_time %}&start_time={{ start_time }}{% endif %}{% if end_time %}&end_time={{ end_time }}{% endif %}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // 格式化日期函数
    function formatDate(timestamp) {
        const date = new Date(timestamp * 1000);
        return date.toLocaleString('zh-CN');
    }
    
    // 格式化日期时间为datetime-local格式
    function formatDatetime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp * 1000);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // 重置筛选条件
    function resetFilters() {
        window.location.href = '/admin/dashboard/cards/history/';
    }
    
    // 导出充值历史
    function exportHistory() {
        // 这里可以实现导出功能
        showMessage('导出功能开发中', 'info');
    }
    
    // 显示消息提示
    function showMessage(message, type = 'info', duration = 3000) {
        const messageElement = document.createElement('div');
        messageElement.className = `alert alert-${type} alert-dismissible fade show`;
        messageElement.role = 'alert';
        messageElement.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const content = document.querySelector('.content');
        if (content) {
            content.insertBefore(messageElement, content.firstChild);
            
            setTimeout(() => {
                messageElement.classList.remove('show');
                setTimeout(() => {
                    messageElement.remove();
                }, 150);
            }, duration);
        }
    }
    
    // 设置默认日期时间
    document.addEventListener('DOMContentLoaded', function() {
        const startDateInput = document.getElementById('start_time');
        const endDateInput = document.getElementById('end_time');
        
        // 如果没有设置值，则设置默认值
        if (!startDateInput.value) {
            // 当天0:00
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0);
            startDateInput.value = todayStart.toISOString().slice(0, 16); // 格式: 2023-12-28T00:00
        }
        
        if (!endDateInput.value) {
            // 当前时间
            const now = new Date();
            endDateInput.value = now.toISOString().slice(0, 16); // 格式: 2023-12-28T14:30
        }
    });
</script>
{% endblock %}
{% endblock %}