# 后台管理系统设计与实现（容器化）

## 1. 系统架构

### 1.1 技术栈

* **后端框架**: Actix Web（与现有项目一致）

* **数据库**: PostgreSQL（与现有项目一致）

* **ORM**: Diesel（与现有项目一致）

* **模板引擎**: Tera（用于渲染Web页面）

* **认证**: 基于Session的认证（适合Web界面）

* **静态资源**: 内置静态文件服务

### 1.2 容器化设计

```
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│   用户浏览器/应用    │────▶│        Nginx        │────▶│     RLServer服务      │
└───────────────────┘     └───────────────────┘     └───────────────────┘
                                    │                         │
                                    │                         │
                                    ▼                         ▼
                            ┌───────────────────┐     ┌───────────────────┐
                            │      SSL证书      │     │    PostgreSQL数据库  │
                            └───────────────────┘     └───────────────────┘
```

### 1.3 目录结构

```
RLServer/
├── src/
│   ├── admin/                 # 后台管理相关代码
│   │   ├── handlers/          # 后台页面处理器
│   │   ├── middleware/        # 后台认证中间件
│   │   ├── routes.rs          # 后台路由定义
│   │   └── services/          # 后台业务逻辑
│   ├── templates/             # Tera模板文件
│   │   ├── admin/             # 后台页面模板
│   │   │   ├── auth/          # 认证相关模板
│   │   │   ├── software/      # 软件管理模板
│   │   │   ├── cards/         # 卡密管理模板
│   │   │   ├── users/         # 用户管理模板
│   │   │   └── layouts/       # 布局模板
│   │   └── partials/          # 通用组件模板
│   ├── static/                # 静态资源
│   │   ├── css/               # CSS文件
│   │   ├── js/                # JavaScript文件
│   │   └── images/            # 图片资源
│   ├── database/              # 数据库相关代码（现有）
│   ├── handlers/              # 客户端API处理器（现有）
│   ├── middleware/            # 客户端认证中间件（现有）
│   ├── services/              # 客户端业务逻辑（现有）
│   └── schema.rs              # 数据库表结构（将扩展）
├── Dockerfile                 # 现有的Dockerfile，将扩展以包含后台静态资源和模板
├── docker-compose.yml         # 现有的docker-compose.yml，无需修改
└── .env                       # 环境变量配置，将添加后台相关配置
```

## 2. 数据库设计

### 2.1 新增表

```sql
-- 后台管理员表
CREATE TABLE admin_users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,
    is_superadmin BOOLEAN DEFAULT FALSE,  -- 超级管理员标志
    can_register BOOLEAN DEFAULT TRUE,    -- 控制是否允许注册
    last_login_at TIMESTAMP WITH TIME ZONE,
    last_login_ip VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 后台操作日志表
CREATE TABLE admin_logs (
    id SERIAL PRIMARY KEY,
    admin_id INTEGER NOT NULL REFERENCES admin_users(id),
    action VARCHAR(100) NOT NULL,
    target VARCHAR(100) NOT NULL,
    target_id INTEGER,
    details JSONB,
    ip_address VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 后台会话表（用于Web认证）
CREATE TABLE admin_sessions (
    id SERIAL PRIMARY KEY,
    admin_id INTEGER NOT NULL REFERENCES admin_users(id),
    session_id VARCHAR(255) UNIQUE NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2.2 现有表扩展

```sql
-- 扩展recharge_cards表，添加price字段
ALTER TABLE recharge_cards ADD COLUMN price DECIMAL(10, 2) DEFAULT 0.00;

-- 扩展software表，添加status字段
ALTER TABLE software ADD COLUMN status BOOLEAN DEFAULT TRUE;

-- 扩展users表，添加note和status字段
ALTER TABLE users ADD COLUMN note TEXT;
ALTER TABLE users ADD COLUMN status BOOLEAN DEFAULT TRUE;
```

## 3. 功能设计

### 3.1 后台账号管理系统

* **登录**：Web界面登录，支持记住登录状态

* **注册**：管理员注册，可通过配置开关控制

* **找回密码**：通过邮箱验证码重置

* **角色权限**：超级管理员和普通管理员

* **个人中心**：修改密码、邮箱等

* **操作日志**：记录所有后台操作

### 3.2 软件管理

* **软件列表**：查看所有软件，支持分页和搜索

* **添加软件**：表单添加新软件

* **编辑软件**：修改软件信息

* **删除软件**：从系统中移除

* **软件状态**：启用/禁用软件（禁用后客户端无法获取）

### 3.3 卡密管理

* **生成卡密**：批量生成，支持自定义VIP等级、有效期、数量、售价

* **卡密列表**：查看所有卡密，支持筛选（已使用/未使用）、搜索

* **卡密详情**：查看单个卡密信息

* **充值历史**：查看卡密充值记录，支持按时间、用户筛选

* **卡密统计**：生成卡密使用情况统计

* **售价管理**：设置和修改卡密售价

### 3.4 用户管理

* **用户列表**：查看所有用户，支持分页、搜索、筛选

* **用户详情**：查看用户详细信息

* **调整VIP**：直接修改用户VIP等级和到期时间

* **用户状态**：禁用/启用用户

* **登录记录**：查看用户登录历史（从login\_logs表获取）

* **在线用户**：实时查看当前在线用户（从online\_users表获取）

* **黑名单管理**：添加/移除黑名单

* **备注管理**：添加/修改用户备注

* **操作日志**：所有用户相关操作都会记录到admin\_logs表

### 3.5 拓展功能

* **系统统计**：

  * 用户数量统计

  * 软件数量统计

  * 卡密使用情况统计

  * **销售业绩统计**：支持按周、月、年、自定义时间范围统计

  * **图表可视化**：使用Chart.js展示统计数据

* **数据导出**：导出用户列表、充值记录等为Excel/CSV

* **系统设置**：配置系统参数

* **邮件模板管理**：管理系统邮件模板

## 4. 页面设计

### 4.1 布局设计

* **左侧导航栏**：分类显示所有功能模块

* **顶部工具栏**：搜索、通知、用户信息

* **主内容区**：显示当前页面内容

* **底部信息**：版权信息、系统版本

### 4.2 主要页面

#### 认证页面

* 登录页面

* 注册页面（可开关）

* 忘记密码页面

* 重置密码页面

#### 软件管理页面

* 软件列表页

* 添加软件页

* 编辑软件页

* 软件详情页

#### 卡密管理页面

* 卡密列表页

* 生成卡密页（含售价设置）

* 卡密详情页

* 充值历史页

* 卡密统计页（含销售业绩统计）

#### 用户管理页面

* 用户列表页

* 用户详情页

* 编辑用户页

* 用户登录记录页

* 在线用户页

* 黑名单管理页

#### 拓展功能页面

* 系统统计页（含销售业绩统计）

* 系统设置页

* 操作日志页

* 数据导出页

* 邮件模板管理页

## 5. 容器化实现

### 5.1 Dockerfile 调整

```dockerfile
# 构建阶段
FROM rust:latest as builder
WORKDIR /app
COPY . .
RUN cargo build --release

# 运行阶段
FROM debian:latest
RUN apt-get update && apt-get install -y --no-install-recommends 
    libpq5 
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
# 复制可执行文件
COPY --from=builder /app/target/release/rlserver ./
# 复制模板文件
COPY --from=builder /app/src/templates /app/templates
# 复制静态资源
COPY --from=builder /app/src/static /app/static
# 复制环境变量示例
COPY --from=builder /app/.env.example /app/.env.example

EXPOSE 28001
CMD ["./rlserver"]
```

### 5.2 docker-compose.yml 调整

无需修改现有docker-compose.yml，后台将直接集成到现有的rlserver服务中，通过不同的URL路径区分客户端API和后台管理界面。

### 5.3 环境变量配置

在.env文件中添加后台相关配置：

```
# 后台管理配置
ADMIN_BASE_PATH=/admin              # 后台访问路径前缀
ADMIN_SESSION_SECRET=your-secret-key-here
ADMIN_SESSION_TIMEOUT=86400         # 会话超时时间（秒）
ADMIN_ENABLE_REGISTRATION=true      # 是否允许后台注册
```

## 6. HTTPS支持

后台管理系统将跟随主服务的HTTPS配置：

* 如果主服务启用HTTPS，后台也将使用HTTPS

* 如果主服务使用HTTP，后台也将使用HTTP

* 后台访问地址会自动适配主服务的协议

## 7. 操作说明文件

### 7.1 后台操作手册

创建`ADMIN_OPERATIONS.md`文件，包含：

* 后台系统介绍

* 登录与注册指南

* 各功能模块的使用说明

* 常见问题解答

* 最佳实践

### 7.2 API文档更新

更新`API_DOCS.md`，添加后台API相关内容（如果需要）。

## 8. 访问方式

* **客户端API**: <http://localhost:28001/api（或HTTPS）>

* **后台管理**: <http://localhost:28001/admin（或HTTPS，自动适配主服务协议）>

## 9. 技术特点

* **一体化设计**：Web后台直接集成到现有服务，无需额外部署

* **容器化支持**：与现有系统一起容器化部署，简化运维

* **响应式布局**：适配不同屏幕尺寸

* **直观易用**：友好的用户界面，方便管理员操作

* **安全性高**：完整的认证授权机制，操作日志审计

* **扩展性强**：模块化设计，便于添加新功能

* **性能优化**：高效的模板渲染，数据库查询优化

* **销售业绩统计**：支持按周、月、年、自定义时间范围统计销售业绩

